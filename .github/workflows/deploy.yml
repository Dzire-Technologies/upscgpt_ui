name: Deploy Frontend

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            echo "ðŸš€ Starting deployment..."
            
            cd ${{ secrets.APP_PATH }}

            echo "ðŸ“¦ Pulling latest code..."
            git pull origin main
            
            echo "ðŸ”§ Setting up production configuration..."
            cp docker-compose.prod.yaml docker-compose.yaml
            
            echo "ðŸ›‘ Stopping indianupscgpt-frontend container only..."
            docker compose stop indiantaxgpt-frontend 2>/dev/null || true
            docker compose rm -f indiantaxgpt-frontend 2>/dev/null || true
            
            echo "ðŸ§¹ Cleaning up old froindiantaxgpt-frontendntend images..."
            docker images | grep indianupscgpt-frontend | awk '{print $3}' | xargs -r docker rmi -f 2>/dev/null || true
            
            echo "ðŸ”¨ Building Docker image..."
            docker compose build --no-cache frontend
            
            echo "ðŸŽ¬ Starting frontend container..."
            docker compose -p indianupscgpt-frontend up -d indianupscgpt-frontend

            
            echo "âœ… Deployment complete! Frontend container status:"
            docker compose ps indianupscgpt-frontend
            
            echo "ðŸ“‹ Recent indianupscgpt-frontend logs:"
            docker compose logs --tail=50 indianupscgpt-frontend
            
            echo "ðŸ¥ Health check:"
            docker inspect --format='{{.State.Health.Status}}' indianupscgpt-frontend 2>/dev/null || echo "Container running (no health check)"
