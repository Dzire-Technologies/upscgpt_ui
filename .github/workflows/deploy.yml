name: Deploy IndianUPSCGPT

on:
  push:
    branches:
      - main  # Triggers on push to main branch
  workflow_dispatch:  # Allows manual trigger from GitHub Actions UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            echo "ðŸš€ Starting deployment..."
            
            # Navigate to app directory
            cd ${{ secrets.APP_PATH }}
            
            # Pull latest changes from main branch
            echo "ðŸ“¦ Pulling latest code..."
            git pull origin main
            
            # Use production docker-compose file
            echo "ðŸ”§ Setting up production configuration..."
            cp docker-compose.prod.yaml docker-compose.yaml
            
            # Stop and remove ONLY indianupscgpt-frontend containers (not other containers)
            echo "ðŸ›‘ Stopping indianupscgpt-frontend container only..."
            docker compose stop indianupscgpt-frontend 2>/dev/null || true
            docker compose rm -f indianupscgpt-frontend 2>/dev/null || true
            
            # Remove old indianupscgpt-frontend images only
            echo "ðŸ§¹ Cleaning up old indianupscgpt-frontend images..."
            docker images | grep indiantaxgpt-frontend | awk '{print $3}' | xargs -r docker rmi -f 2>/dev/null || true
            
            # Build with no cache to ensure fresh build
            echo "ðŸ”¨ Building Docker image..."
            docker compose build --no-cache indianupscgpt-frontend
            
            # Start ONLY indianupscgpt-frontend container in detached mode
            echo "ðŸŽ¬ Starting indianupscgpt-frontend container..."
            docker compose up -d indianupscgpt-frontend
            
            # Show indianupscgpt-frontend container status
            echo "âœ… Deployment complete! indianupscgpt-frontend container status:"
            docker compose ps indianupscgpt-frontend
            
            # Show indianupscgpt-frontend logs only
            echo "ðŸ“‹ Recent indianupscgpt-frontend logs:"
            docker compose logs --tail=50 indianupscgpt-frontend
            
            # Verify container is healthy
            echo "ðŸ¥ Health check:"
            docker inspect --format='{{.State.Health.Status}}' indiantaxgpt-frontend 2>/dev/null || echo "Container running (no health check)"

